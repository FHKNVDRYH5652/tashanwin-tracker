<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lightning Storm Tracker - MrPerfect</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1020;--card:#0f1724;--accent:#f59e0b;--muted:#94a3b8;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;background:linear-gradient(180deg,#071126 0%,#021021 100%);color:#e6eef8;padding:20px}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#1e293b,#0ea5a9);display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 6px 24px rgba(2,6,23,0.6)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input, select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    button{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#08121a;font-weight:600;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
    th{color:var(--muted);font-size:12px}
    .controls{display:flex;gap:8px;align-items:center}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:12px;padding:6px 8px}
    .stats{display:flex;gap:12px;flex-wrap:wrap}
    .stat{background:var(--glass);padding:10px;border-radius:10px;min-width:120px}
    .center{text-align:center}
    .chart-wrap{height:220px}
    .footer{color:var(--muted);font-size:13px;text-align:center;margin-top:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr} .card{padding:10px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">MP</div>
      <div>
        <h1>Lightning Storm - Session Tracker</h1>
        <p class="lead">Track rounds, multipliers, ROI, drawdown, and download/import CSV. Helps discipline & analytics (does not predict outcomes).</p>
      </div>
    </header>

    <div class="grid">
      <!-- Main column -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <strong>Add Round</strong>
            <div class="controls">
              <input id="fileInput" type="file" accept="text/csv" style="display:none">
              <button class="small" id="importCsvBtn">Import CSV</button>
              <button class="small" id="downloadCsvBtn">Export CSV</button>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
            <div>
              <label>Timestamp</label>
              <input id="timestamp" type="datetime-local" />
            </div>
            <div>
              <label>Table / Room</label>
              <input id="tableId" placeholder="Table A1" />
            </div>
            <div>
              <label>Round ID</label>
              <input id="roundId" placeholder="Optional" />
            </div>
            <div>
              <label>Session Label</label>
              <input id="sessionLabel" placeholder="Morning 29-Aug" />
            </div>

            <div>
              <label>Bet Amount (₹)</label>
              <input id="betAmount" type="number" min="0" step="0.01" value="0" />
            </div>
            <div>
              <label>Bet Type</label>
              <select id="betType"><option value="Number">Number/Segment</option><option value="Multiplier">Multiplier</option><option value="Other">Other</option></select>
            </div>

            <div>
              <label>Multiplier Shown (e.g., x10)</label>
              <input id="multiplierShown" placeholder="e.g., x10 or leave blank"/>
            </div>
            <div>
              <label>Payout Amount (if win, incl. stake)</label>
              <input id="payoutAmount" type="number" min="0" step="0.01" value="0" />
            </div>

            <div>
              <label>Win?</label>
              <select id="won"><option value="false">No</option><option value="true">Yes</option></select>
            </div>
            <div>
              <label>Balance After Round (optional)</label>
              <input id="balanceAfter" type="number" step="0.01" />
            </div>

            <div style="grid-column:1 / -1">
              <label>Notes</label>
              <textarea id="notes" rows="2" placeholder="Dealer, lag, observation..."></textarea>
            </div>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button id="addRowBtn">Add Round</button>
            <button id="clearBtn" style="background:#374151;color:#fff">Clear Form</button>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <strong>Rounds</strong>
            <div class="toolbar">
              <button id="clearTable" class="small">Clear All</button>
              <button id="downloadReport" class="small">Download Report (CSV)</button>
            </div>
          </div>

          <div style="overflow:auto;max-height:320px">
            <table id="roundsTable">
              <thead>
                <tr><th>#</th><th>Timestamp</th><th>Table</th><th>Round</th><th>Bet</th><th>Bet Type</th><th>Multiplier</th><th>Won</th><th>Payout</th><th>Net</th><th>Balance</th><th>Session</th><th>Notes</th><th></th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <strong>Charts & Metrics</strong>
          <div style="margin-top:10px;display:flex;gap:12px;align-items:flex-start">
            <div style="flex:1">
              <div class="stats" id="statsRow" style="margin-bottom:8px"></div>
              <div class="chart-wrap card" style="padding:12px;margin-top:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);">
                <canvas id="pnlChart" style="width:100%;height:220px"></canvas>
              </div>
            </div>
            <div style="width:260px">
              <div class="card">
                <strong>Quick Filters</strong>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
                  <input id="filterSession" placeholder="Session label filter" />
                  <input id="filterTable" placeholder="Table/Room filter" />
                  <button id="applyFilter" class="small">Apply</button>
                  <button id="resetFilter" class="small" style="background:#334155;color:#fff">Reset</button>
                </div>
              </div>
              <div class="card" style="margin-top:10px">
                <strong>Legend</strong>
                <p class="muted" style="margin:8px 0 0 0">Net = payout - bet. ROI = net / total bet. Hit rate = wins/rounds. Drawdown = max drop from peak balance.</p>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Right column -->
      <div>
        <div class="card center">
          <h3 style="margin:0 0 8px 0">Session Summary</h3>
          <div id="summaryStats" style="display:grid;grid-template-columns:1fr 1fr;gap:8px"></div>
          <div style="margin-top:10px">
            <button id="resetAll" style="width:100%;background:#ef4444;color:#fff">Reset Everything</button>
          </div>
        </div>

        <div class="card">
          <strong>How to use</strong>
          <ol style="padding-left:18px;color:var(--muted);font-size:13px">
            <li>Use Add Round to log each round you played.</li>
            <li>Import the CSV template (or export your session) for record-keeping.</li>
            <li>Watch P&L chart and drawdown to manage risk. This tool does not predict multipliers.</li>
            <li>Use filters to inspect sessions or tables.</li>
          </ol>
        </div>

        <div class="card">
          <strong>Download sample template</strong>
          <p class="muted">A CSV template (same columns as tool) will download when you click below.</p>
          <div style="display:flex;gap:8px">
            <button id="downloadTemplate">Download Template</button>
          </div>
        </div>

      </div>
    </div>

    <div class="footer">Made for discipline & analytics — not for prediction. Use responsibly.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Simple in-memory store
    let rounds = [];
    let filtered = null;

    const selectors = {
      timestamp: document.getElementById('timestamp'),
      tableId: document.getElementById('tableId'),
      roundId: document.getElementById('roundId'),
      sessionLabel: document.getElementById('sessionLabel'),
      betAmount: document.getElementById('betAmount'),
      betType: document.getElementById('betType'),
      multiplierShown: document.getElementById('multiplierShown'),
      payoutAmount: document.getElementById('payoutAmount'),
      won: document.getElementById('won'),
      balanceAfter: document.getElementById('balanceAfter'),
      notes: document.getElementById('notes'),
      roundsTableBody: document.querySelector('#roundsTable tbody'),
      statsRow: document.getElementById('statsRow'),
      summaryStats: document.getElementById('summaryStats'),
      pnlChart: document.getElementById('pnlChart'),
      fileInput: document.getElementById('fileInput')
    };

    // Chart setup
    const chartCtx = selectors.pnlChart.getContext('2d');
    let pnlChart = new Chart(chartCtx, {
      type: 'line',
      data: {labels: [], datasets: [{label:'Cumulative Net (₹)',data:[],fill:true}]},
      options: {responsive:true,maintainAspectRatio:false,scales:{x:{display:true},y:{display:true}}}
    });

    // Utilities
    function calculateNet(bet,payout){
      return Math.round((Number(payout) - Number(bet)) * 100) / 100;
    }

    function renderTable(list){
      selectors.roundsTableBody.innerHTML = '';
      list.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${r.timestamp||''}</td>
          <td>${r.tableId||''}</td>
          <td>${r.roundId||''}</td>
          <td>₹${Number(r.betAmount).toFixed(2)}</td>
          <td>${r.betType||''}</td>
          <td>${r.multiplierShown||''}</td>
          <td>${r.won? 'Yes':'No'}</td>
          <td>₹${Number(r.payoutAmount).toFixed(2)}</td>
          <td>₹${Number(r.netProfit).toFixed(2)}</td>
          <td>${r.balanceAfter||''}</td>
          <td>${r.sessionLabel||''}</td>
          <td>${r.notes||''}</td>
          <td><button class='small' data-index='${i}'>Del</button></td>
        `;
        selectors.roundsTableBody.appendChild(tr);
      });
      selectors.roundsTableBody.querySelectorAll('button').forEach(b=>b.addEventListener('click',e=>{
        const idx = Number(e.target.dataset.index);
        rounds.splice(idx,1); applyCurrentFilter();
      }));
    }

    function computeMetrics(list){
      const totalBets = list.reduce((s,r)=>s+Number(r.betAmount),0);
      const totalPayout = list.reduce((s,r)=>s+Number(r.payoutAmount),0);
      const net = Math.round((totalPayout - totalBets) * 100) / 100;
      const roundsCount = list.length;
      const wins = list.filter(r=>r.won).length;
      const hitRate = roundsCount ? Math.round((wins/roundsCount)*10000)/100 : 0;
      const roi = totalBets ? Math.round((net/totalBets)*10000)/100 : 0;

      // cumulative net and drawdown
      let cum=0, peak=-Infinity, maxDrawdown=0;
      const cumSeries = [];
      list.forEach(r=>{cum += Number(r.netProfit); cumSeries.push(cum); if(cum>peak) peak=cum; const dd = peak - cum; if(dd>maxDrawdown) maxDrawdown = dd;});

      return {totalBets,totalPayout,net,roundsCount,wins,hitRate,roi,cumSeries,maxDrawdown};
    }

    function renderStats(list){
      const m = computeMetrics(list);
      selectors.statsRow.innerHTML = '';
      const statEls = [
        ['Total Bets','₹'+m.totalBets.toFixed(2)],
        ['Total Payout','₹'+m.totalPayout.toFixed(2)],
        ['Net Profit','₹'+m.net.toFixed(2)],
        ['Rounds',m.roundsCount],
        ['Wins',m.wins+' ('+m.hitRate+'%)'],
        ['ROI',m.roi+'%'],
        ['Max Drawdown','₹'+m.maxDrawdown.toFixed(2)]
      ];
      statEls.forEach(s=>{const d=document.createElement('div');d.className='stat';d.innerHTML=`<div style="font-size:12px;color:var(--muted)">${s[0]}</div><div style="font-weight:700;margin-top:6px">${s[1]}</div>`;selectors.statsRow.appendChild(d);});

      // summary side
      const summaryHtml = `
        <div style="padding:8px">Total: ₹${m.totalBets.toFixed(2)}</div>
        <div style="padding:8px">Net: ₹${m.net.toFixed(2)}</div>
        <div style="padding:8px">ROI: ${m.roi}%</div>
        <div style="padding:8px">Hit Rate: ${m.hitRate}%</div>
      `;
      selectors.summaryStats.innerHTML = summaryHtml;

      // chart
      pnlChart.data.labels = m.cumSeries.map((_,i)=>i+1);
      pnlChart.data.datasets[0].data = m.cumSeries;
      pnlChart.update();
    }

    function addRoundFromForm(){
      const r = {
        timestamp: selectors.timestamp.value || new Date().toISOString().slice(0,16).replace('T',' '),
        tableId: selectors.tableId.value,
        roundId: selectors.roundId.value,
        sessionLabel: selectors.sessionLabel.value,
        betAmount: Number(selectors.betAmount.value) || 0,
        betType: selectors.betType.value,
        multiplierShown: selectors.multiplierShown.value,
        payoutAmount: Number(selectors.payoutAmount.value) || 0,
        won: selectors.won.value === 'true',
        balanceAfter: selectors.balanceAfter.value || '',
        notes: selectors.notes.value || ''
      };
      r.netProfit = calculateNet(r.betAmount,r.payoutAmount);
      rounds.push(r);
      applyCurrentFilter();
      clearForm();
    }

    function clearForm(){ selectors.timestamp.value=''; selectors.tableId.value=''; selectors.roundId.value=''; selectors.sessionLabel.value=''; selectors.betAmount.value=0; selectors.betType.value='Number'; selectors.multiplierShown.value=''; selectors.payoutAmount.value=0; selectors.won.value='false'; selectors.balanceAfter.value=''; selectors.notes.value=''; }

    // filters
    function applyCurrentFilter(){
      const fSession = document.getElementById('filterSession').value.trim().toLowerCase();
      const fTable = document.getElementById('filterTable').value.trim().toLowerCase();
      filtered = rounds.filter(r=>{
        if(fSession && !(r.sessionLabel||'').toLowerCase().includes(fSession)) return false;
        if(fTable && !(r.tableId||'').toLowerCase().includes(fTable)) return false;
        return true;
      });
      renderTable(filtered);
      renderStats(filtered);
    }

    // import/export CSV
    function downloadCSV(data, filename="lightning_storm_session.csv"){
      const headers = ['timestamp','table_id_or_room','round_id','bet_amount','bet_type','multiplier_shown','won','payout_amount','net_profit','balance_after_round','session_label','notes'];
      const rows = [headers.join(',')];
      data.forEach(r=>{
        const row = [r.timestamp||'', r.tableId||'', r.roundId||'', r.betAmount||0, r.betType||'', r.multiplierShown||'', r.won, r.payoutAmount||0, r.netProfit||0, r.balanceAfter||'', r.sessionLabel||'', `"${(r.notes||'').replace(/"/g,'""')}"`];
        rows.push(row.join(','));
      });
      const blob = new Blob([rows.join('\n')], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(l=>l.trim());
      if(lines.length<2) return [];
      const headers = lines[0].split(',').map(h=>h.trim());
      const out = [];
      for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(',');
        if(cols.length<headers.length) continue;
        const obj = {};
        headers.forEach((h,idx)=>{
          const key = h.replace(/\s+/g,'_').toLowerCase();
          obj[key]=cols[idx].replace(/^"|"$/g,'');
        });
        // normalize keys
        out.push({
          timestamp: obj.timestamp||'',
          tableId: obj.table_id_or_room||obj.table||'',
          roundId: obj.round_id||'',
          betAmount: Number(obj.bet_amount||0),
          betType: obj.bet_type||'',
          multiplierShown: obj.multiplier_shown||'',
          won: String(obj.won||'').toLowerCase() === 'true',
          payoutAmount: Number(obj.payout_amount||0),
          netProfit: Number(obj.net_profit|| (Number(obj.payout_amount||0) - Number(obj.bet_amount||0))),
          balanceAfter: obj.balance_after_round||'',
          sessionLabel: obj.session_label||'',
          notes: obj.notes||''
        });
      }
      return out;
    }

    // UI events
    document.getElementById('addRowBtn').addEventListener('click',addRoundFromForm);
    document.getElementById('clearBtn').addEventListener('click',clearForm);
    document.getElementById('applyFilter').addEventListener('click',applyCurrentFilter);
    document.getElementById('resetFilter').addEventListener('click',()=>{document.getElementById('filterSession').value='';document.getElementById('filterTable').value='';applyCurrentFilter();});
    document.getElementById('clearTable').addEventListener('click',()=>{if(confirm('Clear all rounds?')){rounds=[];applyCurrentFilter();}});
    document.getElementById('downloadReport').addEventListener('click',()=>downloadCSV(rounds,'lightning_storm_full_session.csv'));
    document.getElementById('downloadTemplate').addEventListener('click',()=>{
      const sample = [{timestamp:'2025-08-29 05:30',tableId:'Table A',roundId:'R1001',betAmount:10,betType:'Number',multiplierShown:'x10',won:true,payoutAmount:110,netProfit:100,balanceAfterRound:1000,sessionLabel:'Morning 29-Aug',notes:'sample'}];
      downloadCSV(sample,'lightning_storm_template.csv');
    });

    // import
    document.getElementById('importCsvBtn').addEventListener('click',()=>document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change',async(e)=>{
      const f = e.target.files[0]; if(!f) return; const txt = await f.text(); const parsed = parseCSV(txt);
      if(parsed.length===0){alert('No rows found in CSV'); return}
      rounds = rounds.concat(parsed); applyCurrentFilter();
    });

    // simple download CSV from toolbar
    document.getElementById('downloadCsvBtn').addEventListener('click',()=>downloadCSV(rounds,'lightning_storm_export.csv'));
    document.getElementById('resetAll').addEventListener('click',()=>{if(confirm('Reset everything? This will clear in-memory data.')){rounds=[];applyCurrentFilter();}});

    // initialize
    applyCurrentFilter();

  </script>
</body>
</html>
