<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loss Recovery - FINAL (Fixed)</title>
  <style>
    body{margin:0;font-family:Arial, sans-serif;background:#0f1720;color:#fff;text-align:center;background-size:cover;background-position:center;min-height:100vh}
    .container{padding:20px;max-width:980px;margin:0 auto}
    .page{display:none;padding:18px}
    .active{display:block}
    .btn{padding:10px 18px;margin:8px;border:none;border-radius:8px;cursor:pointer;background:#ff6b6b;color:#fff;font-weight:700}
    .plans{display:flex;flex-wrap:wrap;justify-content:center;gap:12px;margin-top:20px}
    .plan{background:rgba(255,255,255,0.03);padding:14px;border-radius:10px;cursor:pointer;min-width:140px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
    .selected{outline:3px solid rgba(255,107,107,0.6)}
    img.qr{width:200px;height:200px;margin-top:15px;object-fit:cover}
    #adminPanel{display:none;background:rgba(0,0,0,0.95);padding:16px;text-align:left;border-radius:8px;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:600px;max-height:80vh;overflow-y:auto;z-index:999;color:#eee}
    #cross{position:fixed;top:12px;right:12px;cursor:pointer;font-size:24px;z-index:1000;color:#fff;background:rgba(255,0,0,0.08);padding:6px 10px;border-radius:50%}
    input[type=text], input[type=number]{padding:10px;border-radius:6px;border:none;outline:none;width:80%;max-width:420px;margin:8px 0;background:rgba(255,255,255,0.03);color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border:1px solid rgba(255,255,255,0.06);font-size:14px;text-align:center}
    .small{font-size:13px;color:#cbd5e1}
    .hint{opacity:0.85;font-size:13px}
    .chip{display:inline-block;background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;margin:6px}
  </style>
</head>
<body id="body">
  <div class="container">
    <!-- Welcome Page -->
    <div id="welcome" class="page active">
      <h1>Welcome to Loss Recovery</h1>
      <p class="small">Aapka suagat hai — start recovery journey</p>
      <button class="btn" onclick="goLoss()">Next</button>
    </div>

    <!-- Loss Page -->
    <div id="loss" class="page">
      <h2>Enter your Loss Amount</h2>
      <input type="number" id="lossAmount" placeholder="Enter loss amount (₹)" />
      <div>
        <button class="btn" onclick="confirmLoss()">Confirm</button>
        <button class="btn" onclick="showPage('welcome')">Back</button>
      </div>
      <p class="hint">Example: 1000</p>
    </div>

    <!-- Plan Page -->
    <div id="plan" class="page">
      <h2>Choose a Plan</h2>
      <div class="plans" id="plans"></div>
      <div>
        <button class="btn" onclick="goPayment()">Proceed to Payment</button>
        <button class="btn" onclick="showPage('loss')">Back</button>
      </div>
    </div>

    <!-- Payment Page -->
    <div id="payment" class="page">
      <h2 id="planName"></h2>
      <p>Amount to Pay: ₹<span id="planPrice"></span></p>
      <img src="qr.png" class="qr" alt="QR Code"/>
      <p class="hint">Scan & pay using QR. Enter UTR below and submit for admin approval.</p>
      <input type="text" id="utr" placeholder="Enter UTR / Transaction ID" />
      <div>
        <button class="btn" onclick="submitUTR()">Submit for Approval</button>
        <button class="btn" onclick="showPage('plan')">Back</button>
      </div>
    </div>

    <!-- Strategy Page -->
    <div id="strategy" class="page">
      <h2>Recovery Strategy</h2>
      <div id="strategyContent"></div>
      <div id="strategyButtons"></div>
      <p class="small">Note: Strategy is locked until admin approves your payment. Admin will approve using the admin panel.</p>
    </div>

    <!-- Prediction Page -->
    <div id="predict" class="page">
      <h2>AI Prediction (WINGO 1-min)</h2>
      <p class="small">Enter last 3-digit period number and last results sequence (Small/Big)</p>
      <input type="text" id="period" placeholder="Period (e.g., 123)" />
      <div class="hint">Example last 10: Small Big Small Big Big Big Small Big Small Big</div>
      <input type="text" id="last10" placeholder="Enter last results separated by space" />
      <div>
        <button class="btn" onclick="genPrediction()">Generate AI Prediction</button>
        <button class="btn" onclick="autoFillExample()">Fill Example</button>
      </div>

      <div id="predictionResult"></div>

      <div style="margin-top:12px">
        <button class="btn" onclick="handleRecord('win')">Win</button>
        <button class="btn" onclick="handleRecord('loss')">Loss</button>
        <button class="btn" onclick="showPage('strategy')">Back</button>
      </div>
      <div class="hint" style="margin-top:10px">AI remembers feedback locally to improve future suggestions.</div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h2>Admin Panel (Firebase)</h2>
    <div id="adminRequests" class="small">Loading requests...</div>
    <div style="text-align:right;margin-top:10px"><button class="btn" onclick="closeAdmin()">Close</button></div>
  </div>
  <div id="cross" onclick="openAdmin()">×</div>

<script type="module">
/* =======================
   Firebase & App Setup
   ======================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
import { getDatabase, ref, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBs7eQyMrcN8kJWMHl2ac2UZHlYQ6DypD8",
  authDomain: "terminal-xxrr.firebaseapp.com",
  databaseURL: "https://terminal-xxrr-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "terminal-xxrr",
  storageBucket: "terminal-xxrr.firebasestorage.app",
  messagingSenderId: "722753278120",
  appId: "1:722753278120:web:bfa37aab39635a4e57f29d",
  measurementId: "G-E3MZH3E1K5"
};
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase(app);

/* =======================
   Utility & UI helpers
   ======================= */
function speak(t){ try{ let u=new SpeechSynthesisUtterance(t); u.lang='hi-IN'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const bg={'welcome':'anime1.png','loss':'anime2.png','plan':'anime3.png','payment':'anime4.png','strategy':'anime5.png','predict':'anime4.png'};
  document.body.style.backgroundImage = "url('"+(bg[id]||'anime1.png')+"')";
}

/* =======================
   FIXED FUNCTION
   ======================= */
function generateAndStoreTargets(loss, days){
  const l = parseFloat(localStorage.getItem('lossAmount') || loss || '0');
  if(!l || !days) return;
  let targets = [];
  let perDay = Math.floor(l / days);
  let sum = 0;
  for(let i=0;i<days;i++){
    targets.push(perDay);
    sum += perDay;
  }

  // adjust rounding difference
  const diff = Math.round(l - sum);
  if(diff !== 0){
    targets[targets.length - 1] += diff;
  }

  // store
  localStorage.setItem('dayTargets', JSON.stringify(targets));
  const statusArr = Array.from({length: days}, (_,i) => 'Pending');
  localStorage.setItem('dayStatus', JSON.stringify(statusArr));
  localStorage.setItem('currentDay', '1');
  if(!localStorage.getItem('planDays') && selectedPlan) localStorage.setItem('planDays', String(selectedPlan.days));
  if(!localStorage.getItem('planLabel') && selectedPlan) localStorage.setItem('planLabel', selectedPlan.label);
}

/* =======================
   Expose Functions for Inline Buttons
   ======================= */
window.goLoss = goLoss;
window.confirmLoss = confirmLoss;
window.goPayment = goPayment;
window.submitUTR = submitUTR;
window.genPrediction = genPrediction;
window.handleRecord = handleRecord;
window.openAdmin = openAdmin;
window.closeAdmin = closeAdmin;
window.resetPlanConfirm = resetPlanConfirm;
window.autoFillExample = autoFillExample;
window.startTodayPrediction = startTodayPrediction;

</script>
</body>
</html>
